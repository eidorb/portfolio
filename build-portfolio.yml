# This build file commits new balances to portfolio-ledger.
image: archlinux
sources:
  - git@git.sr.ht:~brodie/portfolio
  - git@git.sr.ht:~brodie/portfolio-ledger
tasks:
  - install-dependencies: |
      # Install micromamba.
      curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba
      ./bin/micromamba shell -s posix hook >> ~/.buildenv

      # Install Poetry.
      curl -sSL https://install.python-poetry.org | python3 -
      echo 'export PATH="/home/build/.local/bin:$PATH"' >> ~/.buildenv

      # Source buildenv to access micromamba and Poetry in this session.
      . ~/.buildenv

      # Create the portfolio Mamba environment defined by environment.yml.
      cd portfolio
      micromamba create --file environment.yml --yes

      # Install Python dependencies.
      micromamba run --name portfolio poetry install --no-dev

      # Export secrets.
      cat ~/.secrets >> ~/.buildenv
  - update-balances: |
      # Trust SSH host keys.
      echo git.sr.ht ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDZ+l/lvYmaeOAPeijHL8d4794Am0MOvmXPyvHTtrqvgmvCJB8pen/qkQX2S1fgl9VkMGSNxbp7NF7HmKgs5ajTGV9mB5A5zq+161lcp5+f1qmn3Dp1MWKp/AzejWXKW+dwPBd3kkudDBA1fa3uK6g1gK5nLw3qcuv/V4emX9zv3P2ZNlq9XRvBxGY2KzaCyCXVkL48RVTTJJnYbVdRuq8/jQkDRA8lHvGvKI+jqnljmZi2aIrK9OGT2gkCtfyTw2GvNDV6aZ0bEza7nDLU/I+xmByAOO79R1Uk4EYCvSc1WXDZqhiuO2sZRmVxa0pQSBDn1DB3rpvqPYW+UvKB3SOz >> ~/.ssh/known_hosts
      echo git.sr.ht ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCj6y+cJlqK3BHZRLZuM+KP2zGPrh4H66DacfliU1E2DHAd1GGwF4g1jwu3L8gOZUTIvUptqWTkmglpYhFp4Iy4= >> ~/.ssh/known_hosts
      echo git.sr.ht ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMZvRd4EtM7R+IHVMWmDkVU3VLQTSwQDSAvW0t2Tkj60 >> ~/.ssh/known_hosts

      # Update balances.
      cd portfolio-ledger
      micromamba run --name portfolio update-balances

      # Commit to remote repository.
      git status
      git add balances.beancount
      git commit -m "Update balances from job $JOB_URL"
      git push
      complete-build
secrets:
  # SSH key.
  - bc3fa43b-fd2d-4681-8191-603226c49d44
  # ~/.secrets file.
  - d928f525-4679-49e3-a0e9-df344460af7a
